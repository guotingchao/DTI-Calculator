name: ðŸ“¦ Build & Deploy DTI Calculator

on:
  push:
    branches: [main]
  # æ‰‹åŠ¨è§¦å‘é€‰é¡¹
  workflow_dispatch:
    inputs:
      branch:
        description: 'ç›®æ ‡åˆ†æ”¯'
        required: true
        default: 'main'
        type: choice
        options:
          - main
      reason:
        description: 'æ‰‹åŠ¨è§¦å‘åŽŸå› '
        required: true
        default: 'æ‰‹åŠ¨éƒ¨ç½²DTIè®¡ç®—å™¨'
        type: string

jobs:
  build-and-deploy:
    name: ðŸ—ï¸ Build & Deploy
    runs-on: ubuntu-latest
    if: >
      (github.event_name == 'workflow_dispatch') ||
      (github.event_name == 'pull_request' && github.event.pull_request.merged == true)
    steps:
      - name: ðŸ“ Checkout repository
        uses: actions/checkout@v4

      - name: ðŸ·ï¸ Generate build info
        id: meta
        run: |
          TIMESTAMP=$(date +%Y%m%d-%H%M%S)
          SHORT_SHA=${GITHUB_SHA::7}
          IMAGE_TAG="dti-calculator:latest"

          echo "timestamp=${TIMESTAMP}" >> $GITHUB_OUTPUT
          echo "short_sha=${SHORT_SHA}" >> $GITHUB_OUTPUT
          echo "image_tag=${IMAGE_TAG}" >> $GITHUB_OUTPUT
          echo "ðŸ·ï¸ Building DTI Calculator - ${TIMESTAMP}-${SHORT_SHA}"

      - name: ðŸ³ Build Docker image
        run: |
          echo "ðŸ³ æž„å»ºDockeré•œåƒ..."
          docker build -t ${{ steps.meta.outputs.image_tag }} .
          echo "âœ… Dockeré•œåƒæž„å»ºå®Œæˆ"

      - name: ðŸš€ Deploy to Dokploy
        env:
          DOKPLOY_DOMAIN: deploy.bytesbeats.com
          DOKPLOY_TOKEN: ${{ secrets.DOKPLOY_TOKEN }}
          PROJECT_NAME: DTI-Calculator
          PR_NUMBER: ${{ github.event_name == 'workflow_dispatch' && '0' || github.event.pull_request.number }}
          PR_TITLE: ${{ github.event_name == 'workflow_dispatch' && inputs.reason || github.event.pull_request.title }}
          PR_AUTHOR: ${{ github.event_name == 'workflow_dispatch' && github.actor || github.event.pull_request.user.login }}
          TARGET_BRANCH: ${{ github.event_name == 'workflow_dispatch' && inputs.branch || github.event.pull_request.base.ref }}
          SOURCE_BRANCH: ${{ github.event_name == 'workflow_dispatch' && 'manual-trigger' || github.event.pull_request.head.ref }}
          COMMIT_SHA: ${{ github.event_name == 'workflow_dispatch' && github.sha || github.event.pull_request.merge_commit_sha }}
          TRIGGER_TYPE: ${{ github.event_name }}
          IMAGE_INFO: ${{ steps.meta.outputs.image_tag }}
        run: |
          # DTIè®¡ç®—å™¨éƒ¨ç½²è„šæœ¬

          echo "ðŸŽ¯ DTIè®¡ç®—å™¨éƒ¨ç½²é€šçŸ¥"
          echo "=============================="

          if [[ "$TRIGGER_TYPE" == "workflow_dispatch" ]]; then
            echo "ðŸ“ æ‰‹åŠ¨éƒ¨ç½²"
            echo "åŽŸå› : $PR_TITLE"
            echo "æ“ä½œè€…: $PR_AUTHOR"
          else
            echo "ðŸ“¦ PR #$PR_NUMBER åˆå¹¶éƒ¨ç½²"
            echo "æ ‡é¢˜: $PR_TITLE"
            echo "ä½œè€…: $PR_AUTHOR"
            echo "æºåˆ†æ”¯: $SOURCE_BRANCH"
          fi

          echo "ç›®æ ‡åˆ†æ”¯: $TARGET_BRANCH"
          echo "æäº¤SHA: ${COMMIT_SHA::7}"
          echo "é•œåƒä¿¡æ¯: $IMAGE_INFO"
          echo "=============================="

          # å‚æ•°éªŒè¯
          if [[ -z "$DOKPLOY_TOKEN" ]]; then
            echo "âŒ DOKPLOY_TOKEN æœªé…ç½®"
            exit 1
          fi

          # èŽ·å–åº”ç”¨ID
          echo "ðŸ” æŸ¥è¯¢åº”ç”¨ID..."
          response=$(curl -s -w "\n%{http_code}" \
            -X GET "https://${DOKPLOY_DOMAIN}/api/project.all" \
            -H "accept: application/json" \
            -H "x-api-key: ${DOKPLOY_TOKEN}")

          response_body=$(echo "$response" | head -n -1)
          http_code=$(echo "$response" | tail -n 1)

          if [[ $http_code -ne 200 ]]; then
            echo "âŒ æŸ¥è¯¢å¤±è´¥, HTTP: $http_code"
            exit 1
          fi

          app_id=$(echo "$response_body" | jq -r --arg name "$PROJECT_NAME" '
            .[] | .applications[]? | select(.name == $name) | .applicationId' | head -n 1)

          if [[ -z "$app_id" || "$app_id" == "null" ]]; then
            echo "âŒ æœªæ‰¾åˆ°åº”ç”¨: $PROJECT_NAME"
            exit 1
          fi

          echo "âœ… åº”ç”¨ID: $app_id"

          # è§¦å‘éƒ¨ç½²
          echo "ðŸš€ è§¦å‘éƒ¨ç½²..."
          deploy_response=$(curl -s -w "\n%{http_code}" \
            -X POST "https://${DOKPLOY_DOMAIN}/api/application.deploy" \
            -H "accept: application/json" \
            -H "Content-Type: application/json" \
            -H "x-api-key: ${DOKPLOY_TOKEN}" \
            -d "{\"applicationId\": \"$app_id\"}")

          deploy_body=$(echo "$deploy_response" | head -n -1)
          deploy_code=$(echo "$deploy_response" | tail -n 1)

          if [[ $deploy_code -ge 200 && $deploy_code -lt 300 ]]; then
            echo "âœ… éƒ¨ç½²æˆåŠŸ"
            echo ""
            echo "ðŸŽ‰ DTIè®¡ç®—å™¨éƒ¨ç½²å®Œæˆ!"
            echo "åº”ç”¨: $PROJECT_NAME"
            echo "åˆ†æ”¯: $TARGET_BRANCH"
            echo "é•œåƒ: $IMAGE_INFO"
          else
            echo "âŒ éƒ¨ç½²å¤±è´¥,HTTP: $deploy_code"
            echo "å“åº”: $deploy_body"
            exit 1
          fi

      - name: ðŸ“Š Deployment summary
        if: always()
        run: |
          echo "## ðŸš€ DTIè®¡ç®—å™¨éƒ¨ç½²æ‘˜è¦" >> $GITHUB_STEP_SUMMARY
          echo "| é¡¹ç›® | å€¼ |" >> $GITHUB_STEP_SUMMARY
          echo "|------|-----|" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ·ï¸ é¡¹ç›®åç§° | DTI Calculator |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸŒ¿ ç›®æ ‡åˆ†æ”¯ | ${{ github.event_name == 'workflow_dispatch' && inputs.branch || github.event.pull_request.base.ref }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ³ é•œåƒæ ‡ç­¾ | ${{ steps.meta.outputs.image_tag }} |" >> $GITHUB_STEP_SUMMARY
          echo "| â° éƒ¨ç½²æ—¶é—´ | $(date -u '+%Y-%m-%d %H:%M:%S UTC') |" >> $GITHUB_STEP_SUMMARY
          echo "| âœ… æ•´ä½“çŠ¶æ€ | éƒ¨ç½²å®Œæˆ |" >> $GITHUB_STEP_SUMMARY